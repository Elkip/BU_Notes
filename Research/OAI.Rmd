# OAI Research

Mitchell Henschel

#### Introduction

This prediction analysis (objective 2) will use all baseline OAI subjects to see if the TKR subgroups identified in objective 1 are predictable using baseline information. This analysis will be done using the set of the most clinically meaningful clusters identified in objective 1, by random forests. To avoid biases due to study withdrawal or death before TKR these will be modeled as separate multinomial outcomes. So, the outcome has 3 levels (alive and free of TKR (reference), withdrew from study without TKR, and death (without TKR) in addition to one level for each of the clusters identified in objective 1. Relevant interactions in the covariates detected in the random forest analysis will be considered for inclusion in the multinomial logistic regression model in addition to the covariates and any other relevant predictors.

## Settings

```{r settings, warning=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE, message=FALSE, warning=FALSE)

library(tidyverse)
library(nnet) # For multinomial model
library(ggeffects) # Plotting function for regression models
library(randomForest)

options(scipen = 999) # No scientific notation

DATAPATH <- Sys.getenv("OAI_DATA")
if (DATAPATH == "" ) stop( "Please add datapaath to OAI_DATA" )
```

There are 24 variables of interest in this data set:

-   ID

-   AGE

-   SEX (1 = Male, 2 = Female)

-   Current Employment (3 Columns)

    -   CEMPLOY_NWOR - Not working due to other
    -   CEMPLOY_NWH - Not working due to health
    -   CEMPLOY_FB - Unpaid work for family business
    -   CEMPLOY_W - Works for pay (reference)

-   Education Level (4 factor columns)

    -   V00EDCV_GradDeg - Graduate Degree
    -   V00EDCV_SomeGrad - Some Grad School
    -   V00EDCV_UGDeg - Undergrad Degree
    -   V00EDCV_SomeUG - Some Undergrad
    -   V00EDCV_HSDeg - High School Diploma
    -   V00EDCV_LessHS - No High School (reference)

-   MEDINS - Insurance prescript payment (factor)

-   PASE - Physical Activity Score for the Elderly

-   Baseline X-ray Composite OA Grade (4 factor columns)

    -   P01OAGRD_Severe
    -   P01OAGRD_Moderate
    -   P01OAGRD_Mild
    -   P01OAGRD_Possible
    -   P01OAGRD_Normal (reference)

-   Hand Nodes (2 Factor Columns)

    -   P02JBMPCV_NEW_None - no new hand nodules
    -   P02JBMPCV_NEW_One - New hand nodules on one hand
    -   P02JBMPCV_NEW_Both - New hand nodules on both hands (reference)

-   WOMADL - WOMAC Disability Score

-   WOMKP - WOMAC Pain Score

-   WOMSTF - WOMAAC Stiffness Score

-   V00WTMAXKG - Self-reported max weight (kg)

-   V00WTMINKG - Self-reported min weight (kg)

-   BMI

-   HEIGHT - Average Height

-   WIEGHT - Average Weight

-   COMORBSCORE - Charlson Score

-   CESD - Depression Scale Score

-   NSAID (factor) - Use of NSAIDs

-   NARC (factor) - Use of Narcotics

-   Race (2 factor columns)

    -   RACE_AA - African-American
    -   RACE_NW - Other Non-White
    -   White (reference)

-   ETHNICITY (factor) - Reported Hispanic or latino

-   SURG_INJ_HIST (factor) - History of surgery or injury

## Data Loading

Begin by loading in the data from clinical visit 0.

```{r baslineData}
getBaselineData <- function(path) {
  print("Loading Files...")
  enrollees_raw <- read.csv(file.path(path, "Enrollees.txt"), header = T, sep = "|")
  clinical0_raw <- read.csv(file.path(path, "AllClinical00.txt"), header = T, sep = "|")
  
  print("Formatting Enrollees Data...")
  enrollees <- data.frame(enrollees_raw) %>% 
    mutate_all(list(~gsub(":.*", "", .))) %>%
    mutate_all(na_if, "") %>% 
    mutate_all(na_if, ".")
  
  e_df <- enrollees %>%
    select(ID = ID, SEX = P02SEX, RACE = P02RACE, ETHNICITY = P02HISP)
  remove(enrollees_raw)
  
  print("Formatting Clinical 0 Data...")
  clinical0 <- data.frame(clinical0_raw) %>% 
    mutate_all(list(~gsub(":.*", "", .))) %>%
    mutate_all(na_if, "") %>%
    mutate_all(na_if, ".")
  
  c0_df <- clinical0  %>%
    mutate(P01OAGRD = pmax(P01OAGRDL, P01OAGRDR), 
           P02JBMPCV_NEW = case_when(
             P02JBMPCV == 0 ~ 0,
             P02JBMPCV == 3 ~ 2,
             TRUE ~ 1),
           WOMADL = pmax(V00WOMADLL, V00WOMADLR),
           WOMKP = pmax(V00WOMKPL, V00WOMKPR),
           WOMSTF = pmax(V00WOMSTFL, V00WOMSTFR),
           Surg_Inj_Hist = pmax(P02KSURG, P02KINJ),
           .keep = "all")
  remove(clinical0_raw)
  
  print("Joining dataframes...")
  data_baseline <- inner_join(e_df, c0_df, by = "ID")  %>%
    select(ID = ID, AGE = V00AGE, SEX = SEX, CEMPLOY = V00CEMPLOY, EDCV = V00EDCV, 
           MEDINS = V00MEDINS, PASE = V00PASE, P01OAGRD = P01OAGRD,
           P02JBMPCV_NEW = P02JBMPCV_NEW, WOMADL = WOMADL, WOMKP = WOMKP, 
           WOMSTF = WOMSTF, V00WTMAXKG = V00WTMAXKG,  V00WTMINKG = V00WTMINKG, 
           BMI = P01BMI, HEIGHT = P01HEIGHT, WEIGHT = P01WEIGHT, 
           COMORBSCORE = V00COMORB, CESD = V00CESD, NSAID = V00RXNSAID, NARC = V00RXNARC,
           RACE=RACE, ETHNICITY = ETHNICITY, Surg_Inj_Hist = Surg_Inj_Hist)
  remove(c0_df) 
  
  print("Creating factor columns...")
  data_baseline <- data_baseline %>% 
    mutate(CEMPLOY_NWOR = coalesce(if_any(CEMPLOY, `==`, 4), 0),
           CEMPLOY_NWH = coalesce(if_any(CEMPLOY, `==`, 3), 0),
           CEMPLOY_FB = coalesce(if_any(CEMPLOY, `==`, 2), 0),
           EDCV_GradDeg = coalesce(if_any(EDCV, `==`, 5), 0),
           EDCV_SomeGrad = coalesce(if_any(EDCV, `==`, 4), 0),
           EDCV_UGDeg = coalesce(if_any(EDCV, `==`, 3), 0),
           EDCV_SomeUG = coalesce(if_any(EDCV, `==`, 2), 0),
           EDCV_HSDeg = coalesce(if_any(EDCV, `==`, 1), 0),
           P01OAGRD_Severe = coalesce(if_any(P01OAGRD, `==`, 4), 0),
           P01OAGRD_Moderate = coalesce(if_any(P01OAGRD, `==`, 3), 0),
           P01OAGRD_Mild = coalesce(if_any(P01OAGRD, `==`, 2), 0),
           P01OAGRD_Possible = coalesce(if_any(P01OAGRD, `==`, 1), 0),
           P02JBMPCV_NEW_None = coalesce(if_any(P02JBMPCV_NEW, `==`, 0), 0),
           P02JBMPCV_NEW_One = coalesce(if_any(P02JBMPCV_NEW, `==`, 1), 0),
           RACE_AA = coalesce(if_any(RACE, `==`, 2), 0),
           RACE_NW = coalesce(if_any(RACE, `>`, 2), 0)
    ) %>% 
    select(-c(CEMPLOY, EDCV, P01OAGRD, P02JBMPCV_NEW, RACE)) 
  
  print("Converting column types...")
  num_col <- c(1:2, 5:15)
  fac_col <- c(3, 4, 16:35)
  data_baseline[,num_col] <- sapply(data_baseline[,num_col], as.numeric)
  for (i in fac_col) {
    data_baseline[,i] <- sapply(data_baseline[,i], as.factor) 
  }
  print("Baseline Data Loading Complete")
  return(data_baseline)
}

bsln <- getBaselineData(DATAPATH)
```

Next obtain the events. The outcomes are as followed:

-   1: No event, no death

-   2: Left study before event

-   3: Death

-   4...8: Five-Level Random Forest Clusters

```{r eventData}
outcomeLabel <- function(i) {
  switch(as.character(i),
         '1' = {"No Event"},
         '2' = {"Drop Out"},
         '3' = {"Death"},
         (paste("Knee Replacement Cluster", i-3))
  )
}

getEvents <- function(path) {
  outcomes_raw <- read.csv(file.path(path, "Outcomes99.txt"), header = T, sep = "|")
  outcomes <- data.frame(outcomes_raw) %>% 
    mutate_all(list(~gsub(":.*", "", .))) %>%
    mutate_all(na_if, ".") %>%
    replace(is.na(.), 0)  %>% 
    mutate_all(na_if, "") %>% 
    mutate(ID = id, DTH = V99EDDCF, # Death
           DTH_DT = V99EDDDATE,     # Date of Death
           DTH_VST = V99EDDVSPR,    # Closest OAI contact prior to death
           KNEE_RPLC_PRE = pmax(V99ERKBLRP, V99ELKBLRP), # Knee replacement at baseline
           KNEE_RPLC = pmax(V99ERKRPSN, V99ELKRPSN),     # Knee replacement seen on follow-up
           KNEE_OUTCM = pmax(V99ERKTLPR, V99ELKTLPR),    # Total or Partial Follow-up knee replacement
           KNEE_CONF = pmax(V99ELKRPCF, V99ERKRPCF),     # Replacement Confirmation 
           KNEE_RPLC_DT = pmin(V99ERKDATE, V99ERKDATE, na.rm = T), # Knee Replacement Date
           KNEE_RPLC_VST = pmin(V99ELKVSPR, V99ERKVSPR, na.rm = T), # Closest OAI prior to replacement
           LAST_CONTACT = V99RNTCNT,
           .keep = "none")
  events <- outcomes %>% mutate(ID = as.numeric(ID), 
                                EVNT = as.factor(case_when(
                                  KNEE_CONF != 0 ~ 4,
                                  (LAST_CONTACT != 11 & DTH != 0) ~ 3,
                                  LAST_CONTACT != 11 ~ 2,
                                  TRUE ~ 1
                                )),
                                EVNT_VST = case_when(
                                  EVNT == 3 ~ KNEE_RPLC_VST,
                                  EVNT == 4 ~ DTH_VST,
                                  TRUE ~ LAST_CONTACT
                                ),
                                .keep = "none")
  return(events)
}

evnt <- getEvents(DATAPATH)
```

Lastly, combine the 4th level of knee replacements with the 5-level random forest clusters determined by Brooke in a separate analysis.

```{r completeData, warning=FALSE}
getCompleteData <- function(path, cluster) {
  clstrs_bsln_info <- read.csv(file.path(path, "OAI_Clust_Assignments_w_info_V5.csv"), header = T, sep = ",")

  # Attach predicted RF K=5 cluster ID to baseline data
  clstrs <- clstrs_bsln_info[,c("ID",cluster)]
  
  # Create the knee replacement event represented by 4 through 8
  clstrs[,cluster] <- clstrs[,cluster] - 1 # Start first cluster at 0
  
  complete_data <- bsln %>% full_join(evnt, by = NULL) %>%
    left_join(clstrs, by = NULL)
  
  complete_data[,cluster] <- complete_data[,cluster] %>% 
    replace_na(0)
  
  complete_data$EVNT <- rowSums(cbind(as.numeric(complete_data$EVNT), 
                                      as.numeric(complete_data[,cluster])))
  
  complete_data <- complete_data %>% select(-cluster)
  
  return(complete_data)
}

data_full <- getCompleteData(DATAPATH, "K.5.Clusters")
```

SomeGrad and SomeUG were previously determined to be insignificant so they will be be merged with the previous education level

```{r dropEduCol}
data_full <- data_full %>% 
  mutate(EDCV_UGDeg = as.factor((as.numeric(data_full$EDCV_UGDeg)-1) + 
                                  (as.numeric(data_full$EDCV_SomeGrad)-1))) %>% 
  mutate(EDCV_HSDeg = as.factor((as.numeric(data_full$EDCV_HSDeg)-1) + 
                                  (as.numeric(data_full$EDCV_SomeUG)-1))) %>%
  select(-c(EDCV_SomeUG, EDCV_SomeGrad))
```

## Analysis of Raw Data

#### Missing Data:

-   There are `r sum(!complete.cases(data_full))` entries in with missing data.
-   `r sum(!complete.cases(data_full[data_full$EVNT >= 4,]))` who received knee replacements
-   `r sum(!complete.cases(data_full[data_full$EVNT < 4,]))` who did not

These observations will be removed from the data

```{r omitNa}
data_full <- na.omit(data_full)
```

#### Number of Events

-   `r nrow(data_full[which(data_full$EVNT == 1),])` subjects with no event of interest
-   `r nrow(data_full[which(data_full$EVNT == 2),])` subjects who dropped out
-   `r nrow(data_full[which(data_full$EVNT == 3),])` subjects who died during the study
-   `r nrow(data_full[which(data_full$EVNT >= 4),])` subjects who received a knee replacement
    -   `r nrow(data_full[which(data_full$EVNT == 4),])` in cluster 1
    -   `r nrow(data_full[which(data_full$EVNT == 5),])` in cluster 2
    -   `r nrow(data_full[which(data_full$EVNT == 6),])` in cluster 3
    -   `r nrow(data_full[which(data_full$EVNT == 7),])` in cluster 4
    -   `r nrow(data_full[which(data_full$EVNT == 8),])` in cluster 5

## Model Selection

It was decided that the base model should always contain age, sex, WOMAC pain score, and BMI. The multinom function from the nnet package is used.

```{r baseMod}
mod_base <- multinom(EVNT ~ AGE + SEX + WOMKP + BMI, data=data_full)
mod_base$AIC
```

The full model contains every predictor of interest

```{r fullMod}
predictors_all <- c("AGE", "SEX", "MEDINS", "PASE", "WOMADL", "WOMKP",
                    "WOMSTF", "V00WTMAXKG", "V00WTMINKG", "BMI", "HEIGHT", "WEIGHT",
                    "COMORBSCORE", "CESD", "NSAID", "NARC", "ETHNICITY", "Surg_Inj_Hist",
                    "CEMPLOY_NWOR", "CEMPLOY_NWH", "CEMPLOY_FB", "EDCV_GradDeg", 
                    "EDCV_UGDeg", "EDCV_HSDeg", "P01OAGRD_Severe", "P01OAGRD_Moderate", 
                    "P01OAGRD_Mild", "P01OAGRD_Possible", "P02JBMPCV_NEW_None", 
                    "P02JBMPCV_NEW_One", "RACE_AA", "RACE_NW")
eqtn_full <- formula(paste("EVNT ~ ", paste(predictors_all, collapse = " + ")))
mod_full <- multinom(eqtn_full, data=data_full)
mod_full$AIC
```

Note the stepwise selection takes a very long time to run, thus I omit step selection when knitting the HTML file.

Forward step-wise selection:

```{r forward, message=FALSE, eval=FALSE}
step_forward <- step(mod_base, direction = 'forward', scope=formula(mod_full), trace=0)
step_forward$anova
# step_forward$coefnames
```

Backwards step-wise selection

```{r backward, message=FALSE, eval=FALSE}
step_backward <- step(mod_full, direction = 'backward', scope=formula(mod_full), trace=0)
step_backward$anova
# step_backward$coefnames
```

Both direction step-wise selection

```{r both, message=FALSE, eval=FALSE}
beststep_both <- step(mod_base, direction = 'both', scope=formula(mod_sat), trace=0)
beststep_both$anova
# beststep_both$coefnames
```

The both direction step-wise selection gives the lowest AIC, I will proceed using the parameters selected from that model. Every level of education will be included.

```{r best, message=FALSE}
predictors_best <- c("AGE", "SEX", "RACE_AA", "CEMPLOY_NWH", "PASE", "WOMKP",
                "WOMSTF", "BMI", "WEIGHT", "CESD", "NSAID", "P01OAGRD_Severe", 
                "P01OAGRD_Moderate", "P01OAGRD_Mild", "P01OAGRD_Possible",
                "EDCV_HSDeg","EDCV_GradDeg", "EDCV_UGDeg", "V00WTMAXKG")
eqtn_best <- formula(paste("EVNT ~ ", paste(predictors_best, collapse = " + ")))
mod_best <- multinom(eqtn_best, data=data_full, maxit = 1000)
summary(mod_best)$coefficients
```

## Plotting the Model of Best Fit

The probabilities and confidence intervals for each level of outcome will be graphed with ggplot and ggeffects libraries

```{r modelStats}
zscore <- summary(mod_best)$coefficients/summary(mod_best)$standard.errors
pvalue <- (1 - pnorm(abs(zscore), 0, 1)) * 2
odds <- exp(coef(mod_best))
param_ci <- confint(mod_best, level = .90)
odds_ci <- exp(param_ci)
```

Plot the probabilities of being in each outcome based on predictor level:

```{r probPlot, message=FALSE, warning=FALSE}
lapply(predictors_best, function(x) plot(ggpredict(mod_best, terms=paste(x, "[all]"))))
```

Plot confidence intervals of the odds of each outcome compared to the reference group for each predictor:

```{r oddsPlot, message=FALSE, warning=FALSE}
p <- list()
for (i in 1:nrow(odds)) {
  odds_df <- data.frame(boxOdds = odds[i,-1],
                        boxCILow = odds_ci[,1,i][-1],
                        boxCIHigh = odds_ci[,2,i][-1])
  ci_min = min(odds_df$boxCILow)
  ci_max = max(odds_df$boxCIHigh)
  plt <- ggplot(odds_df,  aes(x = boxOdds, y = predictors_best)) + 
    ylab("Predictor") +
    xlab("Odds Ratio") +
    ggtitle(paste("Odds of", outcomeLabel(i+1))) + 
    geom_point() + 
    geom_errorbarh(aes(xmax = boxCIHigh, xmin = boxCILow)) +
    scale_y_discrete(labels = predictors_best) +
    scale_x_continuous(breaks = seq(.1, ci_max + .1, signif((ci_max - ci_min) / 10, 3)),
                       labels = seq(.1, ci_max + .1, signif((ci_max - ci_min) / 10, 3)), 
                       limits = c(ci_min, ci_max)) +
    geom_vline(aes(xintercept = 1), size = .25, linetype = "dashed")
  
  p[[i]] <- plt
}
p
```

## Random Forest Model

Split the data into train and test datasets:

```{r splitData}
set.seed(1)
smp_size <- floor(5*nrow(data_full)/6) # Five-fold
trn_ind <- sample(seq_len(nrow(data_full)), size = smp_size, replace = F)
trn_data <- data_full[trn_ind,]
tst_data <- data_full[-trn_ind,]
```

Build a new random forest using the 8 level outcome as clusters with ALL predictors:

```{r forestFull}
rf_full <- randomForest(as.factor(EVNT) ~  AGE + SEX + RACE_NW
                   + RACE_AA + ETHNICITY + CEMPLOY_NWOR + CEMPLOY_NWH + CEMPLOY_FB 
                   + MEDINS + PASE + WOMADL + WOMKP + WOMSTF + BMI + HEIGHT 
                   + WEIGHT + COMORBSCORE + CESD + NSAID + NARC + P01OAGRD_Severe
                   + P01OAGRD_Moderate + P01OAGRD_Mild + P01OAGRD_Possible 
                   + P02JBMPCV_NEW_None + P02JBMPCV_NEW_One + EDCV_GradDeg + EDCV_UGDeg 
                   + EDCV_HSDeg+ V00WTMAXKG + V00WTMINKG + Surg_Inj_Hist, 
                   data=trn_data, proximity=TRUE, localImp = TRUE)
plot(rf_full, log="y")
table(predict(rf_full), trn_data$EVNT)
# getTree(rf_full, 1, labelVar = TRUE)
# importance(rf_full)
varImpPlot(rf_full)
```

Check accuracy of this forest with testing dataset:

```{r fullAccuracy}
pred <- predict(rf_full, newdata = tst_data)
table(pred, tst_data$EVNT)
```

Now only using the selected predictors from the model of best fit:

```{r forestBest}
eqtn_frst <- formula(paste("as.factor(EVNT) ~ ", paste(predictors_best, collapse = " + ")))
rf_best <- randomForest(eqtn_frst, data=trn_data, proximity=TRUE, localImp = TRUE)
plot(rf_best, log="y")
# importance(rf_best)
varImpPlot(rf_best)
table(predict(rf_best), trn_data$EVNT)
```

Comparing to test dataset:

```{r bestAccuracy}
pred <- predict(rf_best, newdata = tst_data)
table(pred, tst_data$EVNT)
```

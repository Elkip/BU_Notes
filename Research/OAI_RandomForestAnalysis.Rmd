---
title: "OAI - Random Forest Analysis"
author: "Mitchell Henschel"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: 
  html_document:
    toc: true
    toc_collapsed: true
    toc_depth: 3
    number_sections: true
    theme: journal
---

## Settings

```{r settings, warning=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE, message=FALSE, warning=FALSE)
library(tidyverse)
library(fossil)
library(randomForest)
options(scipen = 999) # No scientific notation
```

### Data Loading

```{r loadData, message=FALSE, warning=FALSE}
DATAPATH <- Sys.getenv("OAI_DATA")
if (DATAPATH == "" ) stop( "Please add datapath to OAI_DATA" )

source("OAI_LoadData.R", chdir = T) # LoadData must be in working directory

if(!exists('data_full')) {
  
  if(!exists('bsln')) {
    bsln <- getBaselineData(DATAPATH)
  }
  
  if(!exists('evnt')) {
    evnt <- getEvents(DATAPATH)
  }
  
  data_k5 <- getCompleteData(DATAPATH, "K.5.Clusters")
  data_full <- data_k5
  remove(data_k5)
  remove(evnt)
  remove(bsln)
}
data_full <- na.omit(data_full)
clusters <- getClusterData(DATAPATH)
```

# Comparing 4 vs 5 Cluster - Rand Index

Random Forest Comparision

```{r}
rf4 <- clusters[,"RF.4.Clusters"]
rf5 <- clusters[,"RF.5.Clusters"]
rand.index(rf4, rf5)
adj.rand.index(rf4, rf5)
remove(rf4, rf5)
```

K4 vs K5 Comparision

```{r}
k4 <- clusters[,"K.4.Clusters"]
k5 <- clusters[,"K.5.Clusters"]
rand.index(k4, k5)
adj.rand.index(k4, k5)
remove(k4, k5)
```

# Recreating Random Forest Clusters

```{r splitData}
knees <- data_full[which(as.numeric(data_full$EVNT) >= 4),]
knees$EVNT <- as.numeric(knees$EVNT) - 3

set.seed(1)
smp_size <- floor(5*nrow(knees)/6) # Five-fold
trn_ind <- sample(seq_len(nrow(knees)), size = smp_size, replace = F)
trn_data <- knees[trn_ind,]
tst_data <- knees[-trn_ind,]
```

## Only knee replacement data with ALL predictors:

```{r forestKneesFull}
rf_knees_all <- randomForest(as.factor(EVNT) ~  AGE + SEX + RACE_O + CEMPLOY_NW + MEDINS + PASE + WOMADL + WOMKP + WOMSTF + BMI + HEIGHT  + WEIGHT + COMORBSCORE + DPRSD + NSAID + NARC + P01OAGRD_Severe + P01OAGRD_Moderate + P01OAGRD_Mild + P01OAGRD_Possible  + P02JBMPCV_NEW_None + P02JBMPCV_NEW_One + EDCV_GradDeg + EDCV_UGDeg + EDCV_HSDeg+ V00WTMAXKG + V00WTMINKG + Surg_Inj_Hist, data=trn_data, proximity=TRUE, localImp = TRUE)
plot(rf_knees_all, log="y")
table(predict(rf_knees_all), trn_data$EVNT)
# getTree(rf_full, 1, labelVar = TRUE)
# importance(rf_full)
varImpPlot(rf_knees_all)
```

## Only knee replacement data with BEST predictors

```{r forestKneesBest}
rf_knees_best <- randomForest(as.factor(EVNT) ~  AGE + SEX + RACE_O + PASE + WOMKP + WOMSTF + BMI + HEIGHT  + WEIGHT + NSAID + P01OAGRD_Severe + P01OAGRD_Moderate + P01OAGRD_Mild + P01OAGRD_Possible  + EDCV_GradDeg + EDCV_UGDeg + EDCV_HSDeg+ V00WTMAXKG + Surg_Inj_Hist, data=trn_data, proximity=TRUE, localImp = TRUE)
plot(rf_knees_best, log="y")
table(predict(rf_knees_best), trn_data$EVNT)
# getTree(rf_full, 1, labelVar = TRUE)
# importance(rf_full)
varImpPlot(rf_knees_best)
```

# All outcome random forest using ALL predictors

Omitted due to lack of accuracy and meaningful results

Split the data into train and test datasets:

```{r splitData, eval=FALSE}
set.seed(1)
smp_size <- floor(5*nrow(data_full)/6) # Five-fold
trn_ind <- sample(seq_len(nrow(data_full)), size = smp_size, replace = F)
trn_data <- data_full[trn_ind,]
tst_data <- data_full[-trn_ind,]
```

Build a new random forest using the 8 level outcome as clusters with ALL predictors:

```{r forestFull, eval=FALSE}
rf_full <- randomForest(as.factor(EVNT) ~  AGE + SEX + RACE_O + CEMPLOY_NW + MEDINS + PASE + WOMADL + WOMKP + WOMSTF + BMI + HEIGHT  + WEIGHT + COMORBSCORE + DPRSD + NSAID + NARC + P01OAGRD_Severe + P01OAGRD_Moderate + P01OAGRD_Mild + P01OAGRD_Possible  + P02JBMPCV_NEW_None + P02JBMPCV_NEW_One + EDCV_GradDeg + EDCV_UGDeg + EDCV_HSDeg+ V00WTMAXKG + V00WTMINKG + Surg_Inj_Hist, data=trn_data, proximity=TRUE, localImp = TRUE)
plot(rf_full, log="y")
table(predict(rf_full), trn_data$EVNT)
# getTree(rf_full, 1, labelVar = TRUE)
# importance(rf_full)
varImpPlot(rf_full)
```

Check accuracy of this forest with testing dataset:

```{r fullAccuracy, eval=FALSE}
pred <- predict(rf_full, newdata = tst_data)
table(pred, tst_data$EVNT)
```

## All outcome randome forest only using the selected predictors of best fit:

```{r forestBest, eval=FALSE}
rf_best <- randomForest(as.factor(EVNT) ~  AGE + SEX + RACE_O + PASE + WOMKP + WOMSTF + BMI + HEIGHT  + WEIGHT + NSAID + P01OAGRD_Severe + P01OAGRD_Moderate + P01OAGRD_Mild + P01OAGRD_Possible  + EDCV_GradDeg + EDCV_UGDeg + EDCV_HSDeg+ V00WTMAXKG + Surg_Inj_Hist, data=trn_data, proximity=TRUE, localImp = TRUE)
plot(rf_best, log="y")
# importance(rf_best)
varImpPlot(rf_best)
table(predict(rf_best), trn_data$EVNT)
```

Comparing to test dataset:

```{r bestAccuracy, eval=FALSE}
pred <- predict(rf_best, newdata = tst_data)
table(pred, tst_data$EVNT)
```
